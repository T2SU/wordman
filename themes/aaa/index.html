<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Test</title>
		<link rel="stylesheet" href="/themes/aaa/css/bootstrap.min.css">
		<link rel="stylesheet" href="/themes/aaa/css/all.css">
		<link rel="stylesheet" href="/themes/aaa/css/loading.css">
		<link rel="stylesheet" href="/themes/aaa/css/aaa.css">
		<script src="/themes/aaa/js/jquery-3.3.1.min.js"></script>
		<script src="/themes/aaa/js/bootstrap.min.js"></script>
		<script src="/themes/aaa/js/all.js"></script>
		<meta name="viewport" content="width=device-width, initial-scale=1">
	</head>
	<body class="text-center">
		<header class="head-section">
			<nav class="navbar navbar-dark bg-primary navbar-static-top navbar-expand-lg">
				<a class="navbar-brand" href="/">{{ data['app_ver'] }}</a>
				<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#topbar01" aria-controls="topbar01" aria-expanded="false" aria-label="Toggle navigation">
					<span class="navbar-toggler-icon"></span>
				</button>
				<div class="collapse navbar-collapse" id="topbar01">
					<ul class="navbar-nav mr-auto mt-2 mt-lg-0">
						<li class="nav-item active">
							<a class="nav-link" href="#">List <span class="sr-only">(current)</span></a>
						</li>
						<li class="nav-item">
							<a class="nav-link" href="#">Add</a>
						</li>
					</ul>
					<form class="form-inline my-1 my-lg-0">
						<input class="form-control mr-sm-1" type="search" placeholder="Search" aria-label="Search">
						<button class="btn btn-outline-light my-2 my-sm-0" type="submit">Search</button>
					</form>
					<div class="form-inline my-1 my-lg-0 mx-1">
						<input class="form-control mr-sm-1" type="text" placeholder="Word" aria-label="Word" name="new_word" id="new_word">
						<button class="btn btn-outline-light my-2 my-sm-0" id="add_word">Add Word</button>
					</div>
				</div>
			</nav>
		</header>
		<section id="body">
			<div class="container">
				<table class="table">
					<thead class="thead-dark">
						<tr>
							<th data-sortable="true" class="c1">Word</th>
							<th data-sortable="true" class="c2">Refer</th>
							<th data-sortable="true" class="c3 auto-hidden">Last Referred</th>
						</tr>
					</thead>
					<tbody id="word_rows">
                        {% for row in data['data'] %}
						<tr class="word_context">
							<th class="word">{{ row[0] }}</th>
							<td>{{ row[1] }}</td>
							<td class="auto-hidden">{{ row[2] }}</td>
						</tr>
                        {% endfor %}
					</tbody>
				</table>
			</div>
		</section>
		<footer class="footer-small" id="footer">
			<div class="container">
			</div>
		</footer>

		<script>
			
            function new_word() {
                var nw = $('#new_word');
                var val = nw.val().trim();
                if (val.length == 0)
                    return;
                var dat = {"word":val};
                $.ajax({
                    type:'POST',
                    url:'/add',
                    data:dat,
                    success:function(res,st,req){
                        var result_data = $.parseJSON(res);
                        var word_rows = $("#word_rows");
                        var row1 = $('<tr class="word_context"></tr>');
                        var col_word = $('<th class="word"></th>');
                        var col_ref = $('<td></td>');
                        var col_time = $('<td class="auto-hidden"></td>');
                        col_word.append(result_data['word']);
                        col_ref.append(result_data['ref']);
                        col_time.append(result_data['time']);
                        row1.append(col_word);
                        row1.append(col_ref);
                        row1.append(col_time);
                        word_rows.append(row1);
                        $('html, body').animate({
                            scrollTop: word_rows.offset().top
                        }, 1000);
		$('#new_word').val('');
                    },
                    error:function(res,st,req){
                        if (res.status == 400) {
                            alert('이미 있는듯?');
                        } else {
                            alert('error?');
                        }
                    },
                });
            }

            $('#add_word').click(new_word);
            $('#new_word').keypress(function(e) {
                if(e.which == 13) {
                    new_word();
                }
            });

			function word_detail_open(event) {
                if ($(this).data('mode') != 'detail') {
				    var word = $(this).find(".word").html();
                    var new_row = $('<tr class="word_detail"><td></td></tr>').insertAfter(this);
                    var new_td = new_row.find("td");
                    new_td.attr('colspan', '3');

                    var card = $('<div class="card"></div>');

                    var examples_body = $('<div class="card-body"></div>');
                    examples_body.append('<h4 class="card-title">Examples</h4>');

                    var examples_ul = $('<ul></ul>');

                    var first_example_li = $('<li></li>');
                    var second_example_li = $('<li></li>');
                    first_example_li.html('First Example..');
                    second_example_li.html('Second Example..');
                    examples_ul.append(first_example_li);
                    examples_ul.append(second_example_li);

                    var edit_handler = function(evtobj) {
                        var t = $(this);
                        var v = t.data('mode');
                        if (v != 'editing') {
                            var ctx = t.html();
                            var edit_textbox = $('<input type="text" class="form-control form-control-sm mr-sm-1"/>');
                            edit_textbox.val(ctx);
                            t.html(edit_textbox);
                            edit_textbox.focus();

                            t.data('mode', 'editing');
                            t.data('textbox', edit_textbox);
                            t.data('context', t);
                            
                            var edit_completed_handler = function() {
                                var textbox = t.data('textbox');
                                var context = t.data('context');
                                t.data('mode', 'normal');
                                t.data('textbox', null);
                                t.data('context', null);
                                var edited = textbox.val();
                                textbox.remove();
                                context.html(edited);
                            }

                            edit_textbox.focusout(edit_completed_handler);
                            edit_textbox.keypress(function(e) {
                                if(e.which == 13) {
                                    edit_completed_handler();
                                }
                            });
                        }
                    };

                    first_example_li.click(edit_handler);
                    second_example_li.click(edit_handler);

                    var new_example_form = $('<li><form class="form-inline min-100 min-table"><div class="form-group max-100"><div class="min-table-row w-100"><div class="min-table-cell w-100 pr-1"><input type="text" class="form-control form-control-sm mr-sm-1 w-100" placeholder="New Example..."/></div><div class="min-table-cell"><button class="btn btn-sm btn-info my-1 px-4 max-btn">Add</button></div></div></div></form></li>');
                    examples_ul.append(new_example_form);
                    examples_body.append(examples_ul);

                    var synonyms_body = $('<div class="card-body"></div>');
                    synonyms_body.append('<h4 class="card-title">Synonyms</h4>');

                    var synonyms_ul = $('<ul></ul>');
                    synonyms_ul.append('<li>First Synonym..</li>');
                    synonyms_ul.append('<li>Second Synonym..</li>');
                    synonyms_ul.append('<li><form class="form-inline"><input type="text" class="form-control form-control-sm mr-sm-1" placeholder="New Synonym..."/><button class="btn btn-sm btn-info my-1 px-4 max-btn">Add</button></form></li>');
                    synonyms_body.append(synonyms_ul);

                    var antonyms_body = $('<div class="card-body"></div>');
                    antonyms_body.append('<h4 class="card-title">Antonyms</h4>');

                    var antonyms_ul = $('<ul></ul>');
                    antonyms_ul.append('<li>First Antonym..</li>');
                    antonyms_ul.append('<li>Second Antonym..</li>');
                    antonyms_ul.append('<li><form class="form-inline"><input type="text" class="form-control form-control-sm mr-sm-1" placeholder="New Antonym..."/><button class="btn btn-sm btn-info my-1 px-4 max-btn">Add</button></form></li>');
                    antonyms_body.append(antonyms_ul);

                    card.append(examples_body);
                    card.append(synonyms_body);
                    card.append(antonyms_body);
                    new_td.append(card);
                    
                    $(this).data('mode', 'detail');
                    new_row.fadeIn(250, function () {
                        new_row.show();
                    });
                    $(this).data('new_row', new_row);
                }
                else {
                    var new_row = $(this).data('new_row');
                    new_row.fadeOut(250, function () {
                        new_row.remove();
                    });
                    $(this).data('mode', 'summary');
                }
			}
			$('.word_context').click(word_detail_open);

		</script>
	</body>
</html>
